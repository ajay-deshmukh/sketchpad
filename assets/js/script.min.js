const COLORS={red:"#E34A4A",yellow:"#FBFF0F",green:"#33AC4E",blue:"#3C8DED",black:"#000"},MAX_UNDOS=5,TOOLS={pen:"pen",eraser:"eraser",line:"line",rectangle:"rectangle",circle:"circle",text:"text"},toolbar=document.getElementById("toolbar"),textToolInput=document.getElementById("text-tool-input");function distanceFormula(t,e,i,s){return Math.floor(Math.sqrt((e-t)**2+(s-i)**2))}class Sketchpad{constructor(){this.canvas=document.getElementById("canvas"),this.ctx=this.canvas.getContext("2d"),this.bounds=this.canvas.getBoundingClientRect(),this.color=COLORS.red,this.tool=TOOLS.pen,this.pencilWidth=10,this.eraserWidth=10,this.shapeWidth=10,this.fontSize=16,this.fontFamily="Arial",this.drawing=!1,this.currentPosition={x:0,y:0},this.startPosition={x:0,y:0},this.savedCanvas,this.savedActions=[],this.draw=this.draw.bind(this),this.startDrawing=this.startDrawing.bind(this),this.stopDrawing=this.stopDrawing.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.showTextInput=this.showTextInput.bind(this),this.addText=this.addText.bind(this),this.init=this.init.bind(this)}startDrawing(t){this.drawing=!0,this.startPosition.x=t.pageX-this.bounds.left,this.startPosition.y=t.pageY-this.bounds.top,this.savedCanvas=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),this.savedActions.length>=5&&this.savedActions.shift(),this.savedActions.push(this.savedCanvas),this.tool!==TOOLS.text&&this.canvas.removeEventListener("click",this.showTextInput),this.tool!==TOOLS.eraser&&(this.ctx.globalCompositeOperation="source-over"),this.tool===TOOLS.pen||this.tool===TOOLS.eraser?(this.ctx.beginPath(),this.ctx.moveTo(this.startPosition.x,this.startPosition.y),this.ctx.lineCap="round",this.ctx.lineJoin="round",this.tool===TOOLS.pen?(this.ctx.strokeStyle=this.color,this.ctx.lineWidth=this.pencilWidth):(this.ctx.globalCompositeOperation="destination-out",this.ctx.strokeStyle="rgba(0,0,0,1)",this.ctx.lineWidth=this.eraserWidth),this.ctx.lineTo(this.startPosition.x,this.startPosition.y),this.ctx.stroke()):this.tool===TOOLS.text&&this.handleText()}stopDrawing(){this.drawing=!1}onMouseMove(t){this.currentPosition.x=t.pageX-this.bounds.left,this.currentPosition.y=t.pageY-this.bounds.top,this.drawing&&(this.tool===TOOLS.pen||this.tool===TOOLS.eraser?this.draw():this.drawShape())}showTextInput(t){t.target!==textToolInput&&(console.log("lo"),textToolInput.style.display="block",textToolInput.style.left=t.x+"px",textToolInput.style.top=t.y+"px",textToolInput.style.font=`${this.fontSize}px ${this.fontFamily}`,textToolInput.focus())}addText(t){if(13===t.keyCode){let t=textToolInput.getBoundingClientRect();this.ctx.font=`${this.fontSize}px ${this.fontFamily}`,this.ctx.fillText(textToolInput.innerText,t.left-this.bounds.left,t.top+this.fontSize),textToolInput.style.display="none"}}handleText(){textToolInput.innerText="",this.canvas.addEventListener("click",this.showTextInput),window.addEventListener("keydown",this.addText)}draw(){this.ctx.lineTo(this.currentPosition.x,this.currentPosition.y),this.ctx.stroke()}drawShape(){switch(this.ctx.putImageData(this.savedCanvas,0,0),this.ctx.strokeStyle=this.color,this.ctx.lineWidth=this.shapeWidth,this.tool){case TOOLS.line:this.ctx.beginPath(),this.ctx.lineCap="round",this.ctx.moveTo(this.startPosition.x,this.startPosition.y),this.ctx.lineTo(this.currentPosition.x,this.currentPosition.y),this.ctx.stroke();break;case TOOLS.rectangle:this.ctx.beginPath(),this.ctx.lineJoin="miter",this.ctx.moveTo(this.startPosition.x,this.startPosition.y),this.ctx.rect(this.startPosition.x,this.startPosition.y,this.currentPosition.x-this.startPosition.x,this.currentPosition.y-this.startPosition.y),this.ctx.stroke();break;case TOOLS.circle:this.ctx.beginPath();let t=distanceFormula(this.startPosition.x,this.currentPosition.x,this.startPosition.y,this.currentPosition.y);this.ctx.arc(this.startPosition.x,this.startPosition.y,t,0,2*Math.PI),this.ctx.stroke()}}setColor(t){this.color=t}setTool(t){this.tool=t}setPenSize(t){this.pencilWidth=t}setEraserSize(t){this.eraserWidth=t}setShapeSize(t){this.shapeWidth=t}setFontSize(t){this.fontSize=parseInt(t),textToolInput.style.fontSize=t+"px"}setFontFamily(t){this.fontFamily=t}clearCanvas(){this.savedActions.length>=5&&this.savedActions.shift(),this.savedActions.push(this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height)),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}saveCanvas(){}undo(){this.savedActions.length>0&&(this.ctx.putImageData(this.savedActions[this.savedActions.length-1],0,0),this.savedActions.pop())}init(){this.canvas.width=window.innerWidth-toolbar.offsetWidth,this.canvas.height=window.innerHeight,this.canvas.addEventListener("mousedown",this.startDrawing),this.canvas.addEventListener("mouseup",this.stopDrawing),this.canvas.addEventListener("mousemove",this.onMouseMove),window.addEventListener("click",(function(t){t.target!==this.canvas&&(textToolInput.style.display="none")})),window.addEventListener("resize",(function(){this.canvas.width=window.innerWidth-toolbar.offsetWidth,this.canvas.height=window.innerHeight}))}}window.addEventListener("load",(function(){const t=new Sketchpad,e=document.querySelectorAll(".color"),i=document.querySelectorAll(".tool"),s=document.getElementById("pen-slider"),n=document.getElementById("eraser-slider"),o=document.getElementById("shapes-slider"),a=document.getElementById("font-size"),h=document.getElementById("font-family"),r=document.getElementById("trash"),c=document.getElementById("undo"),d=document.getElementById("grid-toggle"),l=(document.getElementById("download"),document.getElementById("grid"));for(let i=0;i<e.length;i++)e[i].addEventListener("click",(function(s){let n=e[i].getAttribute("data-color");t.setColor(COLORS[n]);for(let t=0;t<e.length;t++)e[t].classList.remove("selected-color");e[i].classList.add("selected-color")}));for(let e=0;e<i.length;e++)i[e].addEventListener("click",(function(s){let n=i[e].getAttribute("data-tool");t.setTool(n);for(let t=0;t<i.length;t++)i[t].classList.remove("selected-tool");i[e].classList.add("selected-tool")}));r.addEventListener("click",(function(){t.clearCanvas()})),save.addEventListener("click",(function(){t.saveCanvas()})),s.addEventListener("change",(function(){t.setPenSize(s.value)})),n.addEventListener("change",(function(){t.setEraserSize(n.value)})),o.addEventListener("change",(function(){t.setShapeSize(o.value)})),a.addEventListener("change",(function(){t.setFontSize(a.value)})),h.addEventListener("change",(function(){t.setFontFamily(h.value)})),c.addEventListener("click",(function(){t.undo()})),d.addEventListener("change",(function(t){t.target.checked?l.style.display="block":l.style.display="none"})),t.init()}));